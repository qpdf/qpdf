#!/bin/bash
set -e
cd "$(dirname "$0")"/..

# Setup vcpkg for Windows builds
# This script clones vcpkg if not present and bootstraps it

VCPKG_DIR="${VCPKG_ROOT:-$HOME/vcpkg}"

if [ ! -d "$VCPKG_DIR" ]; then
    echo "Cloning vcpkg to $VCPKG_DIR"
    if ! git clone https://github.com/microsoft/vcpkg.git "$VCPKG_DIR"; then
        echo "ERROR: Failed to clone vcpkg repository" >&2
        exit 1
    fi
fi

cd "$VCPKG_DIR"

# Bootstrap vcpkg if not already done
if [ ! -f "vcpkg" ] && [ ! -f "vcpkg.exe" ]; then
    echo "Bootstrapping vcpkg..."
    if [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "win32" ]]; then
        if ! ./bootstrap-vcpkg.bat; then
            echo "ERROR: Failed to bootstrap vcpkg" >&2
            exit 1
        fi
    else
        if ! ./bootstrap-vcpkg.sh; then
            echo "ERROR: Failed to bootstrap vcpkg" >&2
            exit 1
        fi
    fi
fi

echo "vcpkg is ready at $VCPKG_DIR"
echo "VCPKG_ROOT=$VCPKG_DIR"
