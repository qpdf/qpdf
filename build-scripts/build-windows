#!/bin/bash
set -ex
cd $(dirname $0)/..
wordsize=$1
tool=$2

declare -a cmake_xargs
declare -a ctest_xargs
pacman -Sy --noconfirm tar zip unzip
if [[ $tool == mingw ]]; then
    pacman -Sy --noconfirm make base-devel
    if [ ! -x /c/msys64/mingw$wordsize/bin/g++.exe ]; then
        if [[ $wordsize == 64 ]]; then
            pacman -Sy --noconfirm mingw-w64-x86_64-toolchain
        else
            pacman -Sy --noconfirm mingw-w64-i686-toolchain
        fi
    fi
    PATH="/c/msys64/mingw$wordsize/bin:$PATH"
    config=RelWithDebInfo
    g++ -v
elif [[ $tool == msvc ]]; then
    cl
    config=Release
    cmake_xargs=(--config $config)
    ctest_xargs=(-C $config)
fi
unzip doc.zip
unzip qpdf-external-libs-bin.zip
cwd=`pwd`
PATH=$cwd/libqpdf/build:$PATH

mkdir build
cd build distribution
../cmake-win $tool ci
cmake --build . -j$(nproc) "${cmake_xargs[@]}" -- -k
ctest --verbose "${ctest_xargs[@]}"
cpack -G NSIS -C $config
cpack -G ZIP -C $config
mv qpdf-*.exe qpdf-*.zip ../distribution
sha256sum distribution/*
